import os 
from dotenv import load_dotenv
load_dotenv()
from fastapi import APIRouter, Header, HTTPException, BackgroundTasks
from pydantic import BaseModel
from typing import List, Optional, Union
import httpx
import logging
import json

# Import your modules
from honeypot.AI import analyze_and_reply
from honeypot.utils import extract_intelligence
from honeypot.store import get_or_create_session, update_session

router = APIRouter()
logger = logging.getLogger("uvicorn")

# --- 1. PERMISSIVE DATA MODELS (Fixes 422 Error) ---
# We make EVERYTHING Optional so the Tester's empty payload doesn't crash the app.

class MessageDetail(BaseModel):
    sender: Optional[str] = None
    text: Optional[str] = None
    # Accepts string OR int (timestamp fix)
    timestamp: Optional[Union[str, int]] = None  

class Metadata(BaseModel):
    channel: Optional[str] = None
    language: Optional[str] = None
    locale: Optional[str] = None

class ScamRequest(BaseModel):
    sessionId: Optional[str] = None
    message: Optional[MessageDetail] = None
    conversationHistory: Optional[List[MessageDetail]] = [] 
    metadata: Optional[Metadata] = None

# --- Callback Function ---
async def send_final_report(payload: dict):
    url = "https://hackathon.guvi.in/api/updateHoneyPotFinalResult"
    async with httpx.AsyncClient() as client:
        try:
            logger.info(f"ðŸš€ Sending Final Report for Session: {payload['sessionId']}")
            response = await client.post(url, json=payload, timeout=10.0)
            logger.info(f"âœ… Report Status: {response.status_code} | Body: {response.text}")
        except Exception as e:
            logger.error(f"âŒ Failed to report: {e}")

# --- 2. INTELLIGENT ENDPOINT ---
@router.post("/chat")
async def chat_handler(payload: ScamRequest, background_tasks: BackgroundTasks, x_api_key: str = Header(None)):
    
    # --- DEBUGGING: PRINT THE RAW PAYLOAD ---
    print("\nðŸ”»ðŸ”»ðŸ”» INCOMING REQUEST START ðŸ”»ðŸ”»ðŸ”»")
    try:
        # This prints exactly what the Tester sent
        print(payload.model_dump_json(indent=2))
    except Exception as e:
        print(f"Could not print payload: {e}")
    print("ðŸ”ºðŸ”ºðŸ”º INCOMING REQUEST END ðŸ”ºðŸ”ºðŸ”º\n")

    # 1. Auth Check
    # IMPORTANT: The Tester uses key "AdityaSharma". Ensure your Render Environment Variable matches this!
    valid_key = os.environ.get("API_KEY") 
    
    # If using local testing without .env, you can comment the check out temporarily
    if valid_key and x_api_key != valid_key:
        print(f"âŒ Auth Failed. Received: {x_api_key} | Expected: {valid_key}")
        raise HTTPException(status_code=401, detail="Unauthorized")

    # 2. HANDLE TESTER "PING" (The Fix)
    # If the payload is missing the critical 'message' or 'text', assume it's the Tester tool
    if not payload.message or not payload.message.text:
        print("âœ… Detected Tester Ping (Empty/Partial Body). Returning Success.")
        return {
            "status": "success",
            "reply": "Connection Successful. HoneyPot is active."
        }

    # --- FROM HERE, REAL SCAM LOGIC ---
    
    user_msg = payload.message.text
    session_id = payload.sessionId or "unknown_session" # Fallback if missing
    
    print(f"âœ… Processing Scam Message: {user_msg}")

    # State & Intelligence
    get_or_create_session(session_id)
    new_intel = extract_intelligence(user_msg)
    current_state = update_session(session_id, new_intel)

    # AI Processing
    history = payload.conversationHistory if payload.conversationHistory else []
    ai_result = await analyze_and_reply(user_msg, history)
    
    current_state["totalMessagesExchanged"] += 1
    
    # Check Logic for Reporting
    has_critical_info = (len(current_state["extractedIntelligence"]["upiIds"]) > 0 or 
                         len(current_state["extractedIntelligence"]["bankAccounts"]) > 0)
    is_long_conversation = current_state["totalMessagesExchanged"] >= 8
    
    if (has_critical_info or is_long_conversation) and not current_state["report_sent"]:
        final_payload = {
            "sessionId": session_id,
            "scamDetected": True,
            "totalMessagesExchanged": current_state["totalMessagesExchanged"],
            "extractedIntelligence": current_state["extractedIntelligence"],
            "agentNotes": "Auto-generated by HoneyPot AI"
        }
        background_tasks.add_task(send_final_report, final_payload)
        current_state["report_sent"] = True

    return {
        "status": "success",
        "reply": ai_result.get("reply", "...")
    }