from fastapi import APIRouter, Header, HTTPException
from pydantic import BaseModel
from typing import List, Optional
import json

# Import our new modules
from honeypot.AI import analyze_and_reply
from honeypot.utils import extract_intelligence
from honeypot.store import get_or_create_session, update_session

import os 
from dotenv import load_dotenv
load_dotenv()


router = APIRouter()

# ... (Keep your Pydantic Models: MessageDetail, Metadata, ScamRequest same as before) ...
class MessageDetail(BaseModel):
    sender: str
    text: str
    timestamp: str

class Metadata(BaseModel):
    channel: Optional[str] = None

class ScamRequest(BaseModel):
    sessionId: str
    message: MessageDetail
    conversationHistory: List[MessageDetail]
    metadata: Optional[Metadata] = None

@router.post("/chat")
async def chat_handler(payload: ScamRequest, x_api_key: str = Header(None)):
    
    if x_api_key != os.environ.get("API_KEY"):
        raise HTTPException(status_code=401, detail="Unauthorized")

    user_msg = payload.message.text
    session_id = payload.sessionId
    
    print(f"--- [Session: {session_id}] Incoming Message ---")

    # 1. Initialize/Get Session
    get_or_create_session(session_id)

    # 2. EXTRACT Intelligence (The Spy)
    new_intel = extract_intelligence(user_msg)
    
    # 3. UPDATE Session State (The Memory)
    current_state = update_session(session_id, new_intel)

    # 4. GENERATE Agent Reply (The Brain)
    ai_result = await analyze_and_reply(user_msg, payload.conversationHistory)
    
    # Update count for the agent's reply as well
    current_state["totalMessagesExchanged"] += 1

    # --- 5. PRINT THE REQUIRED JSON (The Verify Step) ---
    # This matches the "Participants must send..." requirement exactly
    final_payload = {
        "sessionId": session_id,
        "scamDetected": ai_result.get("is_scam", True),
        "totalMessagesExchanged": current_state["totalMessagesExchanged"],
        "extractedIntelligence": current_state["extractedIntelligence"],
        "agentNotes": "Auto-generated by HoneyPot AI"
    }
    
    print("\nðŸ”»ðŸ”» DATA TO BE SENT TO CALLBACK ðŸ”»ðŸ”»")
    print(json.dumps(final_payload, indent=2))
    print("ðŸ”ºðŸ”º ----------------------------- ðŸ”ºðŸ”º\n")

    return {
        "status": "success",
        "reply": ai_result.get("reply", "System Error")
    }